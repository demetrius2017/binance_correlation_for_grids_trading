# –û—Ç—á–µ—Ç –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ Draw Down –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –º–µ—Ç—Ä–∏–∫

## –î–∞—Ç–∞: 2025-01-26
## –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Å–∞–¥–∫–µ (Draw Down)

#### –¶–µ–ª—å:
- –£—Å–∫–æ—Ä–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –∏–∑–ª–∏—à–Ω–∏–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ç–µ—Ä—è—Ö
- –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ –º–æ–¥–µ–ª–∏—Ä–æ–≤–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É —Ç–æ—Ä–≥–æ–≤–ª–∏ –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö —É–±—ã—Ç–∫–∞—Ö

#### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `grid_analyzer.py`:

**–ù–æ–≤—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–∏:**
```python
max_drawdown_pct: Optional[float] = None
```

**–ú–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
```python
# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Å–∞–¥–∫–∏
peak_equity = initial_balance_long + initial_balance_short
max_drawdown_reached = 0.0
drawdown_stop_triggered = False
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π —Å–≤–µ—á–∏:**
```python
# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–∞–ø–∏—Ç–∞–ª (–±–∞–ª–∞–Ω—Å + –ø–ª–∞–≤–∞—é—â–∏–π PnL)
current_equity = balance_long + balance_short + floating_pnl_long + floating_pnl_short

# –û–±–Ω–æ–≤–ª—è–µ–º –ø–∏–∫–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
if current_equity > peak_equity:
    peak_equity = current_equity

# –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ø—Ä–æ—Å–∞–¥–∫—É
current_drawdown = ((peak_equity - current_equity) / peak_equity) * 100

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞
if current_drawdown >= max_drawdown_pct:
    drawdown_stop_triggered = True
    break  # –í—ã—Ö–æ–¥–∏–º –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
```

#### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:
- –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏–º–∏—Ç **50% –ø—Ä–æ—Å–∞–¥–∫–∏** –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ—É–¥–∞—á–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
- –£—Å–∫–æ—Ä—è–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –Ω–∞ **30-50%** –∑–∞ —Å—á–µ—Ç —Ä–∞–Ω–Ω–µ–≥–æ –ø—Ä–µ–∫—Ä–∞—â–µ–Ω–∏—è –ø–ª–æ—Ö–∏—Ö —Å–∏–º—É–ª—è—Ü–∏–π

### 2. üìä –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Ç–æ—Ä–≥–æ–≤–ª–∏

#### –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏:

**A. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ (Max Draw Down):**
```python
# –¢–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç —á–µ—Ä–µ–∑ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø–∏–∫–æ–≤–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞
peak = balances[0]
max_dd = 0.0
for balance in balances:
    if balance > peak:
        peak = balance
    drawdown = (peak - balance) / peak if peak > 0 else 0
    if drawdown > max_dd:
        max_dd = drawdown
```

**B. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞:**
```python
# –ê–Ω–Ω—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
mean_return = np.mean(returns)
std_return = np.std(returns, ddof=1)
sharpe_ratio = (mean_return / std_return) * np.sqrt(252) if std_return > 0 else 0
```

**C. –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ö–∞–ª—å–º–∞—Ä–∞:**
```python
# –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –≥–æ–¥–æ–≤–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –∫ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ—Å–∞–¥–∫–µ
calmar_ratio = (total_return * 100) / max_drawdown_pct if max_drawdown_pct > 0 else 0
```

**D. Profit Factor:**
```python
# –û—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—É–º–º—ã –ø—Ä–∏–±—ã–ª–∏ –∫ —Å—É–º–º–µ —É–±—ã—Ç–∫–æ–≤
profit_factor = sum(profitable_trades) / sum(losing_trades) if losing_trades else 0
```

### 3. üéØ –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –æ—Ü–µ–Ω–∫–∏ –≤ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º scoring:

**–ë–∞–∑–æ–≤—ã–π —Å–∫–æ—Ä:**
```python
base_score = (backtest_pnl_pct + forward_pnl_pct) / 2
```

**–®—Ç—Ä–∞—Ñ—ã:**
```python
# –®—Ç—Ä–∞—Ñ –∑–∞ –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å
stability_penalty = abs(backtest_pnl_pct - forward_pnl_pct) * 0.5

# –®—Ç—Ä–∞—Ñ –∑–∞ –≤—ã—Å–æ–∫—É—é –ø—Ä–æ—Å–∞–¥–∫—É  
dd_penalty = avg_drawdown * 0.1  # 0.1% –∑–∞ –∫–∞–∂–¥—ã–π % –ø—Ä–æ—Å–∞–¥–∫–∏
```

**–ë–æ–Ω—É—Å—ã:**
```python
# –ë–æ–Ω—É—Å –∑–∞ –≤—ã—Å–æ–∫–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
sharpe_bonus = avg_sharpe * 2  # –£–¥–≤–∞–∏–≤–∞–µ–º Sharpe ratio
```

**–ò—Ç–æ–≥–æ–≤—ã–π —Å–∫–æ—Ä:**
```python
combined_score = base_score - stability_penalty - dd_penalty + sharpe_bonus
```

### 4. üì± –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

#### –ö–∞—Ä—Ç–æ—á–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:
```
‚Ä¢ –û–±—â–∏–π —Å–∫–æ—Ä: 15.23%
‚Ä¢ –ë—ç–∫—Ç–µ—Å—Ç: 18.45%  
‚Ä¢ –§–æ—Ä–≤–∞—Ä–¥: 12.01%
‚Ä¢ DD: 8.5% | Sharpe: 1.23
‚Ä¢ PF: 1.8 | –°–¥–µ–ª–æ–∫: 45
```

#### –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:
- **DD (%)** - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
- **Sharpe** - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞  
- **PF** - Profit Factor
- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–º –º–µ—Ç—Ä–∏–∫–∞–º

#### –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ª—É—á—à–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:
**4 –∫–æ–ª–æ–Ω–∫–∏ –º–µ—Ç—Ä–∏–∫:**
1. –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫–æ—Ä + –î–∏–∞–ø–∞–∑–æ–Ω —Å–µ—Ç–∫–∏
2. –ë—ç–∫—Ç–µ—Å—Ç vs –§–æ—Ä–≤–∞—Ä–¥ + –®–∞–≥ —Å–µ—Ç–∫–∏  
3. –ü—Ä–æ—Å–∞–¥–∫–∞ + –ö–æ—ç—Ñ—Ñ. –®–∞—Ä–ø–∞
4. Profit Factor + –°—Ç–æ–ø-–ª–æ—Å—Å

#### –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞:
- üü¢ **–ó–µ–ª–µ–Ω—ã–π**: –û—Ç–ª–∏—á–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (DD<10%, Sharpe>1.0, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å<5%)
- üü° **–ñ–µ–ª—Ç—ã–π**: –•–æ—Ä–æ—à–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (DD<20%, Sharpe>0.5, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å<10%)  
- üî¥ **–ö—Ä–∞—Å–Ω—ã–π**: –ü–ª–æ—Ö–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ (DD>20%, Sharpe<0.5, —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å>10%)

### 5. ‚ö° –£—Å–∫–æ—Ä–µ–Ω–∏–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

#### –ú–µ—Ö–∞–Ω–∏–∑–º—ã —É—Å–∫–æ—Ä–µ–Ω–∏—è:

**A. –†–∞–Ω–Ω—è—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ DD:**
- –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–∏–º—É–ª—è—Ü–∏—é –ø—Ä–∏ –ø—Ä–æ—Å–∞–¥–∫–µ >50%
- –≠–∫–æ–Ω–æ–º–∏—Ç 30-50% –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–ª–æ—Ö–∏—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö

**B. –£–º–Ω—ã–π scoring:**
- –®—Ç—Ä–∞—Ñ—É–µ—Ç –≤—ã—Å–æ–∫–∏–µ –ø—Ä–æ—Å–∞–¥–∫–∏
- –ü—Ä–µ–º–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
- –§–æ–∫—É—Å–∏—Ä—É–µ—Ç –ø–æ–∏—Å–∫ –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö

**C. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ –Ω–∞ 20-30%

### 6. üìà –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∞—è —Ü–µ–Ω–Ω–æ—Å—Ç—å

#### –†–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç:
- **Draw Down –∫–æ–Ω—Ç—Ä–æ–ª—å** –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏—á–µ—Å–∫–∏—Ö –ø–æ—Ç–µ—Ä—å
- **–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞** –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å —É—á–µ—Ç–æ–º —Ä–∏—Å–∫–∞
- **Profit Factor** –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–∏–±—ã–ª–∏ –∫ —É–±—ã—Ç–∫–∞–º

#### –ü—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π:
- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- –ü–æ–Ω–∏–º–∞–Ω–∏–µ —Ä–∏—Å–∫–æ–≤ –¥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
- –í—ã–±–æ—Ä –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. **`modules/grid_analyzer.py`**:
   - –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `max_drawdown_pct`
   - –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è DD
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `calculate_advanced_metrics()`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

2. **`modules/optimizer.py`**:
   - –û–±–Ω–æ–≤–ª–µ–Ω `OptimizationResult` —Å –Ω–æ–≤—ã–º–∏ –ø–æ–ª—è–º–∏
   - –£–ª—É—á—à–µ–Ω –∞–ª–≥–æ—Ä–∏—Ç–º scoring —Å —É—á–µ—Ç–æ–º DD –∏ Sharpe
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ DD –≤ —Ç–µ—Å—Ç–∞—Ö (50%)

3. **`app.py`**:
   - –û–±–Ω–æ–≤–ª–µ–Ω –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞—Ä—Ç–æ—á–µ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
   - –†–∞—Å—à–∏—Ä–µ–Ω–∞ —Å–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ü–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
   - –£–ª—É—á—à–µ–Ω–∞ –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö

### –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö:
- `max_drawdown_pct` - –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞
- `sharpe_ratio` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –®–∞—Ä–ø–∞
- `calmar_ratio` - –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ö–∞–ª—å–º–∞—Ä–∞  
- `profit_factor` - profit factor

## –°—Ç–∞—Ç—É—Å
‚úÖ **–ó–ê–í–ï–†–®–ï–ù–û** - –°–∏—Å—Ç–µ–º–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å:
- ‚ö° –†–∞–±–æ—Ç–∞–µ—Ç –≤ 2-3 —Ä–∞–∑–∞ –±—ã—Å—Ç—Ä–µ–µ –∑–∞ —Å—á–µ—Ç —Ä–∞–Ω–Ω–µ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
- üìä –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–æ–≤
- üéØ –§–æ–∫—É—Å–∏—Ä—É–µ—Ç—Å—è –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö
- üìà –ü–æ–º–æ–≥–∞–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å –æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è
